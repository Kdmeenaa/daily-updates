name: Super Automatic Activity

on:
  schedule:
    - cron: "0 5 * * *" # daily at 10:30am IST
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  boost:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # 1) AUTO COMMIT (forces 1 contribution)
    - name: Auto Commit
      run: |
        echo "Daily update: $(date '+%Y-%m-%d %H:%M:%S')" >> daily-log.txt
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add .
        git commit -m "Daily auto commit" || echo "No changes to commit"

    # 2) CREATE DAILY BRANCH
    - name: Create Branch
      run: |
        BRANCH="update-$(date '+%Y%m%d')"
        git checkout -b $BRANCH
        echo "Branch created: $BRANCH"
        git push origin $BRANCH --force

    # 3) AUTO ISSUE CREATE
    - name: Create Issue
      id: create_issue
      uses: actions/github-script@v6
      with:
        script: |
          const issue = await github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: "Daily Auto Issue " + new Date().toISOString(),
            body: "Automatically generated issue for daily activity."
          });
          return issue.data.number;

    # 4) AUTO ISSUE CLOSE
    - name: Close Issue
      uses: actions/github-script@v6
      with:
        script: |
          await github.rest.issues.update({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: ${{ steps.create_issue.outputs.result }},
            state: "closed"
          });

    # 5) CREATE PR (from daily branch â†’ auto-activity)
    - name: Create Pull Request
      id: pr
      continue-on-error: true
      uses: actions/github-script@v6
      with:
        script: |
          const pr = await github.rest.pulls.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: "Daily Auto PR " + new Date().toISOString(),
            head: "update-" + new Date().toISOString().slice(0,10).replace(/-/g,''),
            base: "auto-activity"
          });
          return pr.data.number;

    # 6) AUTO MERGE PR
    - name: Merge PR
      continue-on-error: true
      uses: actions/github-script@v6
      with:
        script: |
          await github.rest.pulls.merge({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: ${{ steps.pr.outputs.result }},
            merge_method: "merge"
          });

    # 7) CLEANUP (delete old branches)
    - name: Cleanup Branches
      continue-on-error: true
      run: |
        git fetch --all
        git for-each-ref refs/remotes/origin/update-* --format="%(refname:short)" | while read branch; do
          git push origin --delete "${branch#origin/}" || true
        done
